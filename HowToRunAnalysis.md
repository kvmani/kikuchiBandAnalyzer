# How to Run the Analysis (CycleGAN → EBSD Reconstruction → Band Widths)

This guide documents an end‑to‑end workflow:

1. Export EBSD patterns from an `.oh5`/`.h5` into 8‑bit PNGs (`kikuchiBandAnalyzer`).
2. Run a CycleGAN model to enhance/denoise the PNGs (external repo).
3. Reconstruct the processed PNGs back into a new HDF5 file (`kikuchiBandAnalyzer`).
4. Run the band‑width pipeline using a YAML configuration (`kikuchiBandAnalyzer`).

Where commands differ, both Windows and Linux/macOS notes are included.

## Assumptions and expectations

- Your EBSD dataset exists as a matching pair in the same folder:
  - `sample.oh5` (or `sample.h5`)
  - `sample.ang`
- The HDF5 layout follows a common EDAX/TSL convention where patterns are stored under:
  - `/<scan_name>/EBSD/Data/Pattern`
  - The scripts in this repo automatically pick the first top‑level group that is not `Manufacturer` or `Version` and treat that as `<scan_name>`.
- The CycleGAN step outputs PNGs with the **exact same filenames** as the exported inputs (e.g. `EBSP_000001.png`, `EBSP_000002.png`, …).

If any of the above is not true for your dataset, you may need to adapt the scripts or add a small conversion step.

## Prerequisites

- Python environment with this repo’s dependencies installed:
  - `pip install -r requirements.txt`
- A clone of the CycleGAN repo you use for inference (for example, `pytorch-CycleGAN-and-pix2pix`) and a working PyTorch install.
- CycleGAN model weights available in the location expected by your inference script.

## Step 1 — Prepare your input data

Put your `.oh5`/`.h5` and `.ang` in one directory (base name must match):

```
my_scan/
  sample.oh5
  sample.ang
```

## Step 2 — Export EBSD patterns to PNGs (export stage)

This repo provides `hdf5_image_export_and_validation.py` which exports the pattern dataset to individual PNG images.

1. Open `hdf5_image_export_and_validation.py` and edit the `config = { ... }` block at the bottom.

   Key fields:
   - `hdf5_file_path`: your `.oh5`/`.h5` file path
   - `output_dir`: where PNGs will be written
   - `stage`: set to `"export"`
   - `options.convert_to_8bit`: keep `True` (CycleGAN typically expects 8‑bit inputs)

   Example (Windows paths shown):

   ```python
   config = {
       "hdf5_file_path": r"C:\path\to\sample.oh5",
       "output_dir": "exported_images/sample_export",
       "processed_image_dir": r"C:\path\to\processed\images",  # ignored in export stage
       "image_shape": (0, 0, 0),  # ignored in export stage
       "stage": "export",
       "options": {
           "base_name": "EBSP_",
           "index_format": "%06d",
           "file_extension": ".png",
           "convert_to_8bit": True,
           "convert_back_to_16bit": True,
           "skip_image_export": True,
       },
   }
   ```

   Notes:
   - The script currently exports from `/<scan_name>/EBSD/Data/Pattern` automatically.
   - `options.skip_image_export` is currently ignored during export (images are always written when `stage == "export"`).

2. Run:

   ```bash
   python hdf5_image_export_and_validation.py
   ```

3. Verify the output folder contains PNGs named like `EBSP_000001.png`, `EBSP_000002.png`, …

![Exported images folder highlighted in the IDE](assets/step3_export_folder.png)

## Step 3 — Run CycleGAN inference on the exported PNGs

Run your CycleGAN inference so that:

- The **input folder** is the exported PNG folder from Step 2.
- The **output folder** contains **PNG files with the same filenames** as the input folder.

Because CycleGAN setups vary, use your CycleGAN repo’s docs and/or run:

```bash
python run_kikuchi_inference.py --help
```

The processed images are typically placed under a folder such as:

`<results_dir>/<model_name>/test_latest/images`

![Opening the terminal in the IDE](assets/step4_open_terminal.png)
![Processed images generated by CycleGAN](assets/step4_inference_results.png)

### Windows note about multi‑line commands

If you see examples that use `\` to continue a command on the next line, those are for bash. In PowerShell use backticks (`` ` ``) or run the command as a single line.

## Step 4 — Reconstruct processed PNGs back into a new HDF5 file (reconstruct stage)

1. In `hdf5_image_export_and_validation.py`, edit the config block again:

   - Set `stage` to `"reconstruct"`.
   - Set `processed_image_dir` to the folder that directly contains `EBSP_000001.png`, …
   - Set `image_shape` to the original pattern stack shape `(N, height, width)`.
     - You can get this from the original HDF5 dataset shape, or from your export step logs.

2. Run:

   ```bash
   python hdf5_image_export_and_validation.py
   ```

3. Confirm output:

   - A sibling file named `<original_stem>_AI_modified.h5` is written next to your input file.
   - Even if the input file is `.oh5`, the script currently writes the reconstruction output using a `.h5` extension. If your downstream tools require `.oh5`, you can rename the extension (it remains standard HDF5).

![Updating `processed_image_dir` and setting stage to reconstruct](assets/step5_config_reconstruct.png)

## Step 5 — Copy/rename the `.ang` so the base name matches

The band‑width pipeline expects the `.ang` file to have the same base name as the HDF5 file you analyze.

Example:

- Output HDF5: `sample_AI_modified.h5`
- Required ANG: `sample_AI_modified.ang`

So copy your original `sample.ang` and rename it to `sample_AI_modified.ang` in the same folder.

## Step 6 — Run the band‑width analyzer (YAML‑driven, non‑interactive)

1. Choose an options file (or make a copy) such as:
   - `bandDetectorOptionsMagnetite.yml`
   - `bandDetectorOptionsHcp.yml`

2. Edit it:
   - Set `h5_file_path` to your reconstructed HDF5 path (e.g. `.../sample_AI_modified.h5`).
   - Set `debug: true` (fast cropped run) or `debug: false` (full run).
   - If you are on a headless machine, set `skip_display_EBSDmap: true` to avoid GUI windows.

3. Run:

   ```bash
   python KikuchiBandWidthAutomator.py
   ```

### Expected outputs

Given an input `.../sample_AI_modified.h5`, the automator writes outputs next to it:

- CSV summaries:
  - `sample_AI_modified_bandOutputData.csv`
  - `sample_AI_modified_filtered_band_data.csv`
- A copied/augmented HDF5 with computed datasets:
  - `sample_AI_modified_modified.h5`
- One or more derived `.ang` files with new columns appended:
  - `sample_AI_modified_modified_<suffix>.ang`

## Common problems

- **“File not found” for PNGs during reconstruction**: the processed images must keep the exact same filenames as the exported images.
- **Wrong `image_shape`**: reconstruction needs the exact `(N, height, width)` so it can rebuild the full stack.
- **GUI windows blocking runs**: set `skip_display_EBSDmap: true` and disable plotting options in the YAML.
- **Unexpected HDF5 layout**: your patterns may not be under `/<scan_name>/EBSD/Data/Pattern`. You will need to adapt the dataset path logic in the scripts.
